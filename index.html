<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rola Dados</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a" />
<link rel="icon" href="icon-192.png">

<style>
  :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --card:#0b1220aa; --stroke:#1f2937; }
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
         background:linear-gradient(135deg,#0b1220,#111827); color:var(--fg); display:grid; min-height:100vh; place-items:center; }
  .card { width:min(720px,94vw); background:var(--card); border:1px solid var(--stroke); border-radius:18px;
          padding:20px 18px 16px; box-shadow:0 12px 30px #0007; backdrop-filter: blur(6px); }
  h1 { margin:6px 0 14px; font-size:1.15rem; letter-spacing:.2px; color:#f3f4f6; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
  .field { display:grid; gap:6px; }
  label { font-size:.85rem; color:var(--muted); }
  select { appearance:none; background:#0f172a; color:var(--fg); border:1px solid #233047; border-radius:10px; padding:10px 12px; min-width:160px; font-size:1rem; }
  button { background:var(--accent); color:#062b17; font-weight:700; border:none; border-radius:12px; padding:12px 18px; cursor:pointer; transition:transform .05s ease, opacity .2s ease; }
  button:active { transform:translateY(1px); }
  button[disabled] { opacity:.6; cursor:not-allowed; }

  .dice-wrap { margin:16px 0 10px; }
  .dice-area { display:flex; gap:12px; flex-wrap:wrap; min-height:94px; perspective:900px; }
  .die { width:76px; height:76px; display:grid; place-items:center; border-radius:14px;
         background:#0f172a; border:1px solid #233047; font-size:1.7rem; font-weight:800;
         transform-style:preserve-3d; box-shadow:inset 0 0 0 1px #152238, 0 10px 20px #0008; will-change:transform, filter;
         position:relative; }
  .die::after{ content:""; position:absolute; inset:-1px; border-radius:14px; pointer-events:none;
               background:linear-gradient(135deg,#ffffff10,#00000000 40%); mix-blend-mode:screen; }

  .result { margin-top:6px; padding:12px; background:#0f172a; border:1px solid #233047; border-radius:12px; }
  .result h2 { margin:0 0 8px; font-size:.95rem; color:#cbd5e1; }
  .chips { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .chip { background:#0b1323; border:1px solid #233047; padding:6px 10px; border-radius:999px; font-weight:700; }
  .sum { margin-left:auto; padding:8px 12px; border-radius:999px; background:var(--accent); color:#052814; font-weight:900; }
  .meta { font-size:.8rem; color:#94a3b8; margin-top:8px; }
  .footer { margin-top:10px; font-size:.8rem; color:#94a3b8; text-align:center; }
</style>
</head>
<body>
  <main class="card">
    <h1>Rola Dados</h1>
    <div class="row">
      <div class="field">
        <label for="numDice">N√∫mero de dados (1‚Äì5)</label>
        <select id="numDice" aria-label="N√∫mero de dados"></select>
      </div>
      <div class="field">
        <label for="numSides">Lados por dado (4‚Äì20)</label>
        <select id="numSides" aria-label="Lados por dado"></select>
      </div>
      <button id="rollBtn" aria-label="Rolar os dados">üé≤ Rolar</button>
    </div>

    <div class="dice-wrap">
      <div class="dice-area" id="diceArea" aria-live="polite" aria-atomic="true"></div>
    </div>

    <section class="result" id="resultPanel" aria-live="polite">
      <h2>Resultados</h2>
      <div class="chips" id="chips"></div>
      <div class="meta" id="meta">Pronto para rolar 2d6.</div>
    </section>

    <div class="footer">
      As escolhas ficam salvas at√© voc√™ alterar novamente.
    </div>
  </main>

<script>
/* --- PWA --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
}

/* --- Prefer√™ncias --- */
const LS_KEYS = { dice: 'dice.num', sides: 'dice.sides' };
const DEFAULTS = { dice: 2, sides: 6 }; // padr√£o segue 2d6
function loadSetting(key, fallback) {
  const v = localStorage.getItem(key);
  const n = v !== null ? Number(v) : NaN;
  return Number.isFinite(n) ? n : fallback;
}
function saveSetting(key, value) { localStorage.setItem(key, String(value)); }

/* --- RNG seguro c/ rejei√ß√£o --- */
function secureRandInt(maxExclusive) {
  if (maxExclusive <= 0 || maxExclusive > 0x7fffffff) throw new RangeError('bad range');
  const cryptoObj = (self.crypto || self.msCrypto);
  if (!cryptoObj || !cryptoObj.getRandomValues) return Math.floor(Math.random() * maxExclusive);
  const maxUint = 0x100000000;
  const lim = Math.floor(maxUint / maxExclusive) * maxExclusive;
  const buf = new Uint32Array(1);
  let r;
  do { cryptoObj.getRandomValues(buf); r = buf[0]; } while (r >= lim);
  return r % maxExclusive;
}
function secureRandInRange(min, max) { return min + secureRandInt(max - min + 1); }

/* --- UI --- */
const numDiceSel  = document.getElementById('numDice');
const numSidesSel = document.getElementById('numSides');
const diceArea    = document.getElementById('diceArea');
const rollBtn     = document.getElementById('rollBtn');
const chips       = document.getElementById('chips');
const meta        = document.getElementById('meta');

function fillSelect(select, min, max, defVal) {
  select.innerHTML = '';
  for (let i=min; i<=max; i++) {
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = String(i);
    if (i === defVal) opt.selected = true;
    select.appendChild(opt);
  }
}
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
function syncDiceViews(count) {
  const current = diceArea.children.length;
  for (let i=current; i<count; i++) {
    const d = document.createElement('div');
    d.className = 'die';
    d.textContent = '‚Äî';
    diceArea.appendChild(d);
  }
  for (let i=diceArea.children.length - 1; i>=count; i--) {
    diceArea.removeChild(diceArea.children[i]);
  }
}

function init() {
  const savedDice  = clamp(loadSetting(LS_KEYS.dice,  DEFAULTS.dice), 1, 5);
  const savedSides = clamp(loadSetting(LS_KEYS.sides, DEFAULTS.sides), 4, 20); // <- m√≠nimo 4 agora
  fillSelect(numDiceSel, 1, 5,   savedDice);
  fillSelect(numSidesSel, 4, 20, savedSides); // <- 4‚Äì20
  syncDiceViews(savedDice);

  numDiceSel.addEventListener('change', () => {
    const val = clamp(Number(numDiceSel.value), 1, 5);
    saveSetting(LS_KEYS.dice, val);
    syncDiceViews(val);
  });
  numSidesSel.addEventListener('change', () => {
    const val = clamp(Number(numSidesSel.value), 4, 20); // <- clamp 4‚Äì20
    saveSetting(LS_KEYS.sides, val);
  });

  rollBtn.addEventListener('click', roll);
  updatePanel([], savedDice, savedSides);
}

/* --- Tumble 3D realista (1.5s) ---
   - eixo de rota√ß√£o aleat√≥rio (vetor normalizado)
   - √¢ngulo com in√©rcia e desacelera√ß√£o c√∫bica
   - pequena trajet√≥ria em arco + ‚Äúblur‚Äù leve no come√ßo
*/
let rafs = [];
function clearAllRafs(){ rafs.forEach(id=>cancelAnimationFrame(id)); rafs = []; }

function roll() {
  const n = clamp(Number(numDiceSel.value), 1, 5);
  const s = clamp(Number(numSidesSel.value), 4, 20);
  syncDiceViews(n);

  rollBtn.disabled = true;
  clearAllRafs();

  const diceEls = Array.from(diceArea.children);
  const start = performance.now();
  const duration = 1500;

  // cada dado escolhe um eixo e velocidade inicial
  const spins = diceEls.map((_, i) => {
    // eixo aleat√≥rio (x,y,z) normalizado
    let ax = Math.random()*2-1, ay = Math.random()*2-1, az = Math.random()*2-1;
    const len = Math.hypot(ax, ay, az) || 1; ax/=len; ay/=len; az/=len;
    const w0 = 9 + Math.random()*7; // rad/s inicial (r√°pido no in√≠cio)
    const pathMag = 6 + Math.random()*8; // px de arco
    return { ax, ay, az, w0, pathMag, lastNumChange: 0, i };
  });

  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

  function frame(now) {
    const elapsed = now - start;
    const t = Math.min(elapsed / duration, 1);
    const ease = easeOutCubic(t);
    const w = (1 - ease); // velocidade relativa decrescendo a zero

    diceEls.forEach((d, i) => {
      const sp = spins[i];

      // √¢ngulo acumulado (rad): integra w0 * w * dt aprox. -> usa w0 * (1 - ease)
      const theta = sp.w0 * (elapsed/1000) * (1 - ease*0.85);

      // converte eixo-√¢ngulo em matriz simples -> aplica como rota√ß√µes compostas
      // proje√ß√£o: mix de rotateX/rotateY/rotateZ aproximada
      const rx = (sp.ax * theta) * 180/Math.PI;
      const ry = (sp.ay * theta) * 180/Math.PI;
      const rz = (sp.az * theta) * 180/Math.PI;

      // trajet√≥ria em arco suave
      const arc = sp.pathMag * (1 - ease) * Math.sin((elapsed/1000)*3 + i);
      const arcY = sp.pathMag * 0.6 * (1 - ease) * Math.cos((elapsed/1000)*2.7 + i);

      // leve ‚Äúblur‚Äù no in√≠cio
      const blur = 0.6 * (1 - t);
      d.style.filter = `drop-shadow(0 8px 10px rgba(0,0,0,${0.5 + 0.3*(1-t)})) blur(${blur}px)`;
      d.style.transform = `translate(${arc}px, ${arcY}px) rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(${rz}deg)`;

      // flicker de face: muito r√°pido no come√ßo, desacelera
      const interval = 28 + 300 * t;
      if (elapsed - sp.lastNumChange >= interval) {
        d.textContent = secureRandInRange(1, s);
        sp.lastNumChange = elapsed;
      }
    });

    if (elapsed < duration) {
      rafs.push(requestAnimationFrame(frame));
    } else {
      // resultado final
      const results = [];
      let sum = 0;
      diceEls.forEach((d, i) => {
        const v = secureRandInRange(1, s);
        results.push(v); sum += v;
        d.textContent = v;
        // ‚Äúpop‚Äù de assentamento + limpa blur
        d.style.transition = 'transform 180ms cubic-bezier(.2,1,.2,1), filter 180ms ease';
        d.style.transform += ' scale(1.06) translate(0,0)'; // volta √† base
        d.style.filter = 'drop-shadow(0 8px 12px rgba(0,0,0,.55)) blur(0px)';
        setTimeout(()=>{ d.style.transform = d.style.transform.replace(' scale(1.06)',''); d.style.transition=''; }, 200);
      });
      updatePanel(results, n, s, sum);
      rollBtn.disabled = false;
    }
  }
  rafs.push(requestAnimationFrame(frame));
}

/* --- Painel de resultados --- */
function updatePanel(results, n, s, sum){
  chips.innerHTML = '';
  if (results.length) {
    results.forEach((v, idx) => {
      const c = document.createElement('div');
      c.className = 'chip';
      c.textContent = `Dado ${idx+1}: ${v}`;
      chips.appendChild(c);
    });
    const total = document.createElement('div');
    total.className = 'sum';
    total.textContent = `Total: ${sum}`;
    chips.appendChild(total);
    meta.textContent = `Rolado ${n}d${s} √†s ${new Date().toLocaleTimeString()}.`;
  } else {
    const hint = document.createElement('div');
    hint.className = 'chip';
    hint.textContent = '‚Äî';
    chips.appendChild(hint);
    meta.textContent = `Pronto para rolar ${n}d${s}.`;
  }
}

init();
</script>
</body>
</html>
